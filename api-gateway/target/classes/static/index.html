<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–°–£–ë–î - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä—É–¥–Ω—ã–º–∏ –º–µ—Å—Ç–æ—Ä–æ–∂–¥–µ–Ω–∏—è–º–∏</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        body {
            padding-top: 20px;
            background-color: #f8f9fa;
        }
        .table-wrap {
            max-height: 520px;
            overflow: auto;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
        }
        .data-table {
            font-size: 0.9rem;
            margin-bottom: 0;
        }
        .data-table th {
            position: sticky;
            top: 0;
            background-color: #343a40;
            color: white;
            z-index: 10;
        }
        .section-title {
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .card {
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            margin-bottom: 20px;
        }
        .editable {
            background-color: #fff3cd !important;
            cursor: pointer;
            border: 1px solid #ffc107 !important;
        }
        .editable:hover {
            background-color: #ffeaa7 !important;
        }
        .new-row {
            background-color: #d4edda !important;
        }
        .report-params {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h3 class="mb-0">üìä –°–£–ë–î - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä—É–¥–Ω—ã–º–∏ –º–µ—Å—Ç–æ—Ä–æ–∂–¥–µ–Ω–∏—è–º–∏</h3>
                            <p class="text-muted mb-0">–°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≥–æ—Ä–Ω–æ–¥–æ–±—ã–≤–∞—é—â–∏–º–∏ –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏</p>
                        </div>
                        <div class="text-end">
                            <span id="userRoleLabel" class="badge bg-primary fs-6 me-3"></span>
                            <button class="btn btn-outline-danger" onclick="logout()">
                                <i class="bi bi-box-arrow-right"></i> –í—ã–π—Ç–∏
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h5 class="section-title">–û—Å–Ω–æ–≤–Ω–æ–µ –º–µ–Ω—é</h5>
                    <select id="menuSelect" class="form-select form-select-lg" onchange="onMenuChange(this)">
                    </select>
                </div>
            </div>
        </div>
    </div>

    <div id="contentArea" class="row">
    </div>
</div>

<script>
    const API_BASE_URL = "http://10.0.87.27:8080/api";
    const CORE_BASE_URL = "http://10.0.87.27:8081/api";
    
    const ALL_TABLES = [
        "ore_deposits", "minerals", "buyers_companies", "deposit_owner",
        "reserves", "sales_to_companies", "work_shifts", "mining_teams",
        "shift_production", "miners", "teams", "team_names"
    ];

    const USER_FORBIDDEN_TABLES = ["deposit_owner", "mining_teams", "miners", "teams", "team_names"];

    const USER_VIEWS = [
        "view_deposits_summary",
        "view_reserves_details", 
        "view_sales_report",
        "view_production_daily",
        "view_team_performance",
        "view_mineral_prices"
    ];

    const EDITABLE_VIEWS = [
        "view_production_daily", 
        "view_sales_report"
    ];

    const VIEW_TO_TABLE_MAP = {
        "view_production_daily": "shift_production",
        "view_sales_report": "sales_to_companies"
    };

    const ONE_TO_MANY_RELATIONS = [
    { 
        base: "ore_deposits", 
        baseDisplayName: "–ú–µ—Å—Ç–æ—Ä–æ–∂–¥–µ–Ω–∏—è",
        baseIdField: "id",
        baseNameField: "name",
        childTable: "reserves", 
        childDisplayName: "–ó–∞–ø–∞—Å—ã –º–µ—Å—Ç–æ—Ä–æ–∂–¥–µ–Ω–∏–π",
        childFk: "ore_deposit_id", 
        childPk: "id" 
    },
    { 
        base: "minerals", 
        baseDisplayName: "–ú–∏–Ω–µ—Ä–∞–ª—ã",
        baseIdField: "id",
        baseNameField: "name",
        childTable: "reserves", 
        childDisplayName: "–ó–∞–ø–∞—Å—ã –º–∏–Ω–µ—Ä–∞–ª–æ–≤",
        childFk: "mineral_id", 
        childPk: "id" 
    },
    { 
        base: "minerals", 
        baseDisplayName: "–ú–∏–Ω–µ—Ä–∞–ª—ã",
        baseIdField: "id",
        baseNameField: "name",
        childTable: "sales_to_companies", 
        childDisplayName: "–ü—Ä–æ–¥–∞–∂–∏ –º–∏–Ω–µ—Ä–∞–ª–æ–≤",
        childFk: "mineral_id", 
        childPk: "id" 
    },
    { 
        base: "buyers_companies", 
        baseDisplayName: "–ö–æ–º–ø–∞–Ω–∏–∏-–ø–æ–∫—É–ø–∞—Ç–µ–ª–∏",
        baseIdField: "id",
        baseNameField: "name",
        childTable: "sales_to_companies", 
        childDisplayName: "–ü—Ä–æ–¥–∞–∂–∏ –∫–æ–º–ø–∞–Ω–∏–∏",
        childFk: "buyer_id", 
        childPk: "id" 
    },
    { 
        base: "work_shifts", 
        baseDisplayName: "–†–∞–±–æ—á–∏–µ —Å–º–µ–Ω—ã",
        baseIdField: "id",
        baseNameField: "shift_date",
        childTable: "shift_production", 
        childDisplayName: "–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ –∑–∞ —Å–º–µ–Ω—É",
        childFk: "shift_id", 
        childPk: "id" 
    },
    { 
        base: "mining_teams", 
        baseDisplayName: "–ì–æ—Ä–Ω–æ–¥–æ–±—ã–≤–∞—é—â–∏–µ –∫–æ–º–∞–Ω–¥—ã",
        baseIdField: "id",
        baseNameField: "foreman_name",
        childTable: "work_shifts", 
        childDisplayName: "–°–º–µ–Ω—ã –∫–æ–º–∞–Ω–¥—ã",
        childFk: "mining_team_id", 
        childPk: "id" 
    }
];

    // –†–µ–∞–ª—å–Ω—ã–µ –æ—Ç—á–µ—Ç—ã –∏–∑ –±—ç–∫–µ–Ω–¥–∞
// –†–µ–∞–ª—å–Ω—ã–µ –æ—Ç—á–µ—Ç—ã –∏–∑ –±—ç–∫–µ–Ω–¥–∞
const REAL_REPORTS = [
    { 
        id: "monthly-production", 
        name: "–ï–∂–µ–º–µ—Å—è—á–Ω–∞—è –¥–æ–±—ã—á–∞ –ø–æ –º–µ—Å—Ç–æ—Ä–æ–∂–¥–µ–Ω–∏—è–º",
        params: [
            { name: "year", type: "number", label: "–ì–æ–¥", placeholder: "2024" },
            { name: "month", type: "number", label: "–ú–µ—Å—è—Ü", placeholder: "1-12", optional: true }
        ]
    },
    { 
        id: "sales-by-mineral", 
        name: "–ü—Ä–æ–¥–∞–∂–∏ –ø–æ –≤–∏–¥–∞–º –º–∏–Ω–µ—Ä–∞–ª–æ–≤",
        params: [
            { name: "from", type: "date", label: "–ù–∞—á–∞–ª—å–Ω–∞—è –¥–∞—Ç–∞" },
            { name: "to", type: "date", label: "–ö–æ–Ω–µ—á–Ω–∞—è –¥–∞—Ç–∞" }
        ]
    },
    { 
        id: "reserves-status", 
        name: "–°—Ç–∞—Ç—É—Å –∑–∞–ø–∞—Å–æ–≤",
        params: [
            { 
                name: "isConfirmed", 
                type: "select", 
                label: "–°—Ç–∞—Ç—É—Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è",
                options: [
                    { value: "", label: "–í—Å–µ" },
                    { value: "true", label: "–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω—ã–µ" },
                    { value: "false", label: "–ù–µ–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω—ã–µ" }
                ]
            }
        ]
    },
    { 
        id: "infrastructure-report", 
        name: "–û—Ç—á–µ—Ç –ø–æ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–µ –º–µ—Å—Ç–æ—Ä–æ–∂–¥–µ–Ω–∏–π",
        params: [
            { name: "q", type: "text", label: "–ü–æ–∏—Å–∫", placeholder: "–ù–∞–∑–≤–∞–Ω–∏–µ –∏–ª–∏ –Ω–∞—Å–µ–ª–µ–Ω–Ω—ã–π –ø—É–Ω–∫—Ç", optional: true }
        ]
    },
    { 
        id: "team-efficiency", 
        name: "–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Ä–∞–±–æ—Ç—ã –≥–æ—Ä–Ω–æ–¥–æ–±—ã–≤–∞—é—â–∏—Ö –∫–æ–º–∞–Ω–¥",
        params: [
            { name: "year", type: "number", label: "–ì–æ–¥", placeholder: "2024" },
            { name: "month", type: "number", label: "–ú–µ—Å—è—Ü", placeholder: "1-12" }
        ]
    },
    { 
        id: "buyer-statistics", 
        name: "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø–æ–∫—É–ø–∞—Ç–µ–ª—è–º",
        params: [
            { name: "from", type: "date", label: "–ù–∞—á–∞–ª—å–Ω–∞—è –¥–∞—Ç–∞" },
            { name: "to", type: "date", label: "–ö–æ–Ω–µ—á–Ω–∞—è –¥–∞—Ç–∞" }
        ]
    },
    { 
        id: "discovery-timeline", 
        name: "–•—Ä–æ–Ω–æ–ª–æ–≥–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–µ—Å—Ç–æ—Ä–æ–∂–¥–µ–Ω–∏–π",
        params: [] // –ë–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
    },
    { 
        id: "equipment-damage", 
        name: "–û—Ç—á–µ—Ç –æ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏—è—Ö –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è",
        params: [
            { name: "from", type: "date", label: "–ù–∞—á–∞–ª—å–Ω–∞—è –¥–∞—Ç–∞", optional: true },
            { name: "to", type: "date", label: "–ö–æ–Ω–µ—á–Ω–∞—è –¥–∞—Ç–∞", optional: true }
        ]
    }
];

    let currentUser = null;
    let currentTableName = null;
    let currentTableData = [];
    let modifiedRows = new Set();
    let newRows = new Set();

    async function initApp() {
        try {
            const resp = await axios.get(`${API_BASE_URL}/me`);
            const data = resp.data;
            const roles = data.roles.map(r => r.authority);
            currentUser = {
                username: data.username,
                role: roles.includes("ROLE_ADMIN") ? "ADMIN" : "USER"
            };
            
            document.getElementById("userRoleLabel").innerText = 
                `${currentUser.username} (${currentUser.role === "ADMIN" ? "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä" : "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"})`;
            
            initMenu();
        } catch (e) {
            console.error("–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:", e);
            alert("–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.");
        }
    }

    function initMenu() {
        const menu = document.getElementById("menuSelect");
        menu.innerHTML = "";

        const options = currentUser.role === "ADMIN" 
            ? [
                "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü–∞–º–∏",
                "–°–≤—è–∑–∏ –æ–¥–∏–Ω-–∫–æ-–º–Ω–æ–≥–∏–º"
            ]
            : [
                "–ü—Ä–æ—Å–º–æ—Ç—Ä –¥–∞–Ω–Ω—ã—Ö (–ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è)",
                "–°–≤—è–∑–∏ –æ–¥–∏–Ω-–∫–æ-–º–Ω–æ–≥–∏–º",
                "–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–æ–≤",
                "–í–≤–æ–¥ –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è"
            ];

        options.forEach(option => {
            const opt = document.createElement("option");
            opt.value = option;
            opt.textContent = option;
            menu.appendChild(opt);
        });

        onMenuChange();
    }

    function onMenuChange() {
        const val = document.getElementById("menuSelect").value;
        
        switch(val) {
            case "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü–∞–º–∏":
                showTablesView();
                break;
            case "–ü—Ä–æ—Å–º–æ—Ç—Ä –¥–∞–Ω–Ω—ã—Ö (–ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è)":
                showViewsView();
                break;
            case "–°–≤—è–∑–∏ –æ–¥–∏–Ω-–∫–æ-–º–Ω–æ–≥–∏–º":
                showRelationsView();
                break;
            case "–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–æ–≤":
                showReportsView();
                break;
            case "–í–≤–æ–¥ –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è":
                showDataInputView();
                break;
        }
    }

    function showTablesView() {
        const content = document.getElementById("contentArea");
        const defaultTable = "ore_deposits";
        currentTableName = defaultTable;

        content.innerHTML = `
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <div class="row mb-4">
                            <div class="col-md-8">
                                <h5 class="section-title">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü–∞–º–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö</h5>
                            </div>
                            <div class="col-md-4">
                                <select id="tableSelect" class="form-select" onchange="loadTable(this.value)">
                                    ${ALL_TABLES.map(table => 
                                        `<option value="${table}" ${table === defaultTable ? 'selected' : ''}>
                                            ${getTableDisplayName(table)}
                                        </option>`
                                    ).join('')}
                                </select>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <button class="btn btn-success w-100 mb-2" onclick="saveCurrentTable()">
                                    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
                                </button>
                            </div>
                            <div class="col-md-4">
                                <button class="btn btn-primary w-100 mb-2" onclick="addRow()">
                                    –î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å
                                </button>
                            </div>
                            <div class="col-md-4">
                                <button class="btn btn-danger w-100 mb-2" onclick="deleteSelectedRow()">
                                    –£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω–æ–µ
                                </button>
                            </div>
                        </div>
                        
                        <div class="table-wrap bg-white">
                            <div id="tableContainer" class="p-3"></div>
                        </div>
                    </div>
                </div>
            </div>
        `;

        loadTable(defaultTable);
    }

    function showViewsView() {
        const content = document.getElementById("contentArea");
        const defaultView = USER_VIEWS[0];

        content.innerHTML = `
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <div class="row mb-4">
                            <div class="col-md-8">
                                <h5 class="section-title">–ü—Ä–æ—Å–º–æ—Ç—Ä –¥–∞–Ω–Ω—ã—Ö (—Ä–µ–∂–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)</h5>
                            </div>
                            <div class="col-md-4">
                                <select id="viewSelect" class="form-select" onchange="loadView(this.value)">
                                    ${USER_VIEWS.map(view => 
                                        `<option value="${view}" ${view === defaultView ? 'selected' : ''}>
                                            ${getViewDisplayName(view)}
                                        </option>`
                                    ).join('')}
                                </select>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="input-group">
                                    <span class="input-group-text">üîç</span>
                                    <input type="text" id="searchInput" class="form-control" 
                                           placeholder="–ë—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫..." oninput="filterTable()">
                                </div>
                            </div>
                        </div>
                        
                        <div class="table-wrap bg-white">
                            <div id="viewContainer" class="p-3"></div>
                        </div>
                    </div>
                </div>
            </div>
        `;

        loadView(defaultView);
    }

    async function loadTable(tableName) {
        const container = document.getElementById("tableContainer");
        currentTableName = tableName;
        
        modifiedRows.clear();
        newRows.clear();
        
        container.innerHTML = "<div class='text-center p-5'><div class='spinner-border'></div><p class='mt-2'>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p></div>";
        
        try {
            const resp = await axios.get(`${CORE_BASE_URL}/tables/${tableName}`);
            renderTable(container, resp.data, true);
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:", error);
            container.innerHTML = `
                <div class="alert alert-danger">
                    <h5>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</h5>
                    <p>${error.response?.data || error.message}</p>
                </div>
            `;
        }
    }

    async function loadView(viewName) {
        const container = document.getElementById("viewContainer");
        currentTableName = viewName;
        container.innerHTML = "<div class='text-center p-5'><div class='spinner-border'></div><p class='mt-2'>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p></div>";
        
        try {
            const resp = await axios.get(`${CORE_BASE_URL}/views/${viewName}`);
            renderTable(container, resp.data, false);
        } catch (e) {
            container.innerHTML = `
                <div class="alert alert-danger">
                    <h5>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è</h5>
                    <p>${e.message}</p>
                </div>
            `;
        }
    }

    function renderTable(container, data, editable) {
        currentTableData = data;
        modifiedRows.clear();
        newRows.clear();
        
        if (!data || data.length === 0) {
            container.innerHTML = "<div class='alert alert-info'>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</div>";
            return;
        }

        const headers = Object.keys(data[0]);
        
        let html = `
            <table class="table table-hover table-striped data-table">
                <thead>
                    <tr>
                        ${editable ? '<th style="width: 50px;">#</th>' : ''}
                        ${headers.map(h => `<th>${getColumnDisplayName(h)}</th>`).join('')}
                    </tr>
                </thead>
                <tbody>
        `;

        data.forEach((row, index) => {
            const rowId = row.id || index;
            const isNew = rowId.toString().startsWith('new_');
            html += `<tr data-id="${rowId}" ${isNew ? 'class="new-row"' : ''}>`;
            
            if (editable) {
                html += `<td><input type="checkbox" class="row-selector" data-id="${rowId}"></td>`;
            }
            
            headers.forEach(col => {
                const value = row[col];
                const displayValue = formatValue(value);
                
                if (editable && col !== "id") {
                    html += `<td class="editable" contenteditable="true" data-col="${col}" 
                              oninput="markRowAsModified('${rowId}')">${displayValue}</td>`;
                } else {
                    html += `<td>${displayValue}</td>`;
                }
            });
            
            html += `</tr>`;
        });

        html += `</tbody></table>`;
        container.innerHTML = html;
    }

    function markRowAsModified(rowId) {
        modifiedRows.add(rowId);
    }

    function addRow() {
        if (!currentTableName) return;
        
        const container = document.getElementById("tableContainer");
        const table = container.querySelector('table');
        if (!table) return;
        
        const tbody = table.querySelector('tbody');
        if (!tbody) return;
        
        const headers = Array.from(table.querySelectorAll('thead th'))
            .map(th => th.textContent.trim())
            .filter(h => h !== '#');
        
        const newRowId = 'new_' + Date.now();
        const newRow = document.createElement('tr');
        newRow.setAttribute('data-id', newRowId);
        newRow.className = 'new-row';
        
        const checkboxCell = document.createElement('td');
        checkboxCell.innerHTML = `<input type="checkbox" class="row-selector" data-id="${newRowId}">`;
        newRow.appendChild(checkboxCell);
        
        headers.forEach((header, index) => {
            const cell = document.createElement('td');
            const colName = getColumnNameFromDisplay(header);
            
            if (colName !== 'id') {
                cell.setAttribute('contenteditable', 'true');
                cell.setAttribute('data-col', colName);
                cell.className = 'editable';
                cell.textContent = '';
                
                cell.addEventListener('input', function() {
                    markRowAsModified(newRowId);
                });
            } else {
                cell.textContent = '–Ω–æ–≤–∞—è';
                cell.className = 'text-muted fst-italic';
            }
            
            newRow.appendChild(cell);
        });
        
        tbody.appendChild(newRow);
        newRows.add(newRowId);
    }

    async function saveCurrentTable() {
    if (!currentTableName) {
        alert("–¢–∞–±–ª–∏—Ü–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞");
        return;
    }

    try {
        const updates = [];
        const creates = [];
        const container = document.getElementById("tableContainer");
        
        const table = container.querySelector('table');
        if (!table) {
            alert("–¢–∞–±–ª–∏—Ü–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");
            return;
        }
        
        const rows = table.querySelectorAll('tbody tr');
        
        // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã
        rows.forEach((row) => {
            const rowId = row.getAttribute('data-id');
            const isNew = rowId && rowId.startsWith('new_');
            const rowData = {};
            
            // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã—Ö —è—á–µ–µ–∫
            row.querySelectorAll('td[contenteditable="true"]').forEach(cell => {
                const col = cell.getAttribute('data-col');
                let value = cell.textContent.trim();
                
                // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ –≤ null
                if (value === '') {
                    value = null;
                } 
                // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º "–î–∞"/"–ù–µ—Ç" –≤ boolean
                else if (value === '–î–∞') {
                    value = true;
                } else if (value === '–ù–µ—Ç') {
                    value = false;
                }
                // –ü—Ä–æ–±—É–µ–º –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —á–∏—Å–ª–∞
                else if (!isNaN(value) && value !== '') {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Ü–µ–ª–æ–µ –ª–∏ —á–∏—Å–ª–æ –∏–ª–∏ –¥—Ä–æ–±–Ω–æ–µ
                    if (value.includes('.')) {
                        value = parseFloat(value);
                    } else {
                        value = parseInt(value);
                    }
                }
                
                rowData[col] = value;
            });
            
            if (isNew && Object.keys(rowData).length > 0) {
                creates.push(rowData);
            } else if (!isNew && modifiedRows.has(rowId) && Object.keys(rowData).length > 0) {
                rowData.id = parseInt(rowId); // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º ID –≤ —á–∏—Å–ª–æ
                updates.push(rowData);
            }
        });
        
        // –°–æ–±–∏—Ä–∞–µ–º ID –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è
        const checkboxes = container.querySelectorAll('.row-selector:checked');
        const deletes = [];
        for (const checkbox of checkboxes) {
            const rowId = checkbox.getAttribute('data-id');
            if (!rowId.startsWith('new_') && rowId) {
                deletes.push(parseInt(rowId));
            }
        }
        
        // –í—ã–ø–æ–ª–Ω—è–µ–º –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
        const results = {
            created: 0,
            updated: 0,
            deleted: 0
        };
        
        // –£–¥–∞–ª–µ–Ω–∏–µ
        for (const id of deletes) {
            try {
                const response = await axios.delete(`${CORE_BASE_URL}/tables/${currentTableName}/${id}`);
                if (response.data.success) {
                    results.deleted++;
                } else {
                    throw new Error(`–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ ID ${id}`);
                }
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:", error);
                throw new Error(`–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å —Å ID ${id}: ${error.response?.data || error.message}`);
            }
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∑–∞–ø–∏—Å–µ–π
        for (const data of updates) {
            try {
                const response = await axios.put(`${CORE_BASE_URL}/tables/${currentTableName}/${data.id}`, data);
                if (response.data.success) {
                    results.updated++;
                } else {
                    throw new Error(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ ID ${data.id}`);
                }
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:", error);
                throw new Error(`–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –∑–∞–ø–∏—Å—å —Å ID ${data.id}: ${error.response?.data || error.message}`);
            }
        }
        
        // –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö –∑–∞–ø–∏—Å–µ–π
        for (const data of creates) {
            try {
                const response = await axios.post(`${CORE_BASE_URL}/tables/${currentTableName}`, data);
                if (response.data.success) {
                    results.created++;
                } else {
                    throw new Error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–ø–∏—Å–∏");
                }
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è:", error);
                throw new Error(`–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å—å: ${error.response?.data || error.message}`);
            }
        }
        
        // –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–∫–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π
        modifiedRows.clear();
        newRows.clear();
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        let message = "‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!\n";
        if (results.created > 0) message += `‚Ä¢ –°–æ–∑–¥–∞–Ω–æ –∑–∞–ø–∏—Å–µ–π: ${results.created}\n`;
        if (results.updated > 0) message += `‚Ä¢ –û–±–Ω–æ–≤–ª–µ–Ω–æ –∑–∞–ø–∏—Å–µ–π: ${results.updated}\n`;
        if (results.deleted > 0) message += `‚Ä¢ –£–¥–∞–ª–µ–Ω–æ –∑–∞–ø–∏—Å–µ–π: ${results.deleted}\n`;
        
        alert(message);
        
        // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Ç–∞–±–ª–∏—Ü—É
        await loadTable(currentTableName);
        
    } catch (error) {
        console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:", error);
        alert("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏:\n" + error.message);
    }
}
    async function deleteSelectedRow() {
        const container = document.getElementById("tableContainer");
        const checkboxes = container.querySelectorAll('.row-selector:checked');
        
        if (checkboxes.length === 0) {
            alert("–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–ø–∏—Å–∏ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è");
            return;
        }
        
        if (confirm(`–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏ (${checkboxes.length})?`)) {
            try {
                for (const checkbox of checkboxes) {
                    const rowId = checkbox.getAttribute('data-id');
                    const row = checkbox.closest('tr');
                    
                    if (rowId && rowId.startsWith('new_')) {
                        row.remove();
                        newRows.delete(rowId);
                    } else if (rowId) {
                        await axios.delete(`${CORE_BASE_URL}/tables/${currentTableName}/${rowId}`);
                        row.remove();
                    }
                }
                
                alert(`–£–¥–∞–ª–µ–Ω–æ –∑–∞–ø–∏—Å–µ–π: ${checkboxes.length}`);
                loadTable(currentTableName);
                
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏:", error);
                alert(`–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏: ${error.response?.data?.message || error.message}`);
            }
        }
    }

    function showRelationsView() {
    const content = document.getElementById("contentArea");
    
    content.innerHTML = `
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h5 class="section-title">–°–≤—è–∑–∏ –æ–¥–∏–Ω-–∫–æ-–º–Ω–æ–≥–∏–º</h5>
                    <p class="text-muted mb-4">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —Å–≤—è–∑–∏ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö</p>
                    
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label class="form-label">–¢–∏–ø —Å–≤—è–∑–∏:</label>
                            <select id="relationSelect" class="form-select" onchange="loadRelation(this.value)">
                                <option value="">${ONE_TO_MANY_RELATIONS[0]}</option>
                                ${ONE_TO_MANY_RELATIONS.map(rel => 
                                    `<option value="${rel.base}:${rel.childTable}">
                                        ${rel.baseDisplayName} ‚Üí ${rel.childDisplayName}
                                    </option>`
                                ).join('')}
                            </select>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-5">
                            <div class="card h-100">
                                <div class="card-header bg-primary text-white">
                                    <i class="bi bi-box-arrow-in-down"></i> 
                                    <span id="parentTitle">–û—Å–Ω–æ–≤–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞</span>
                                </div>
                                <div class="card-body p-0">
                                    <div class="table-wrap" style="height: 450px;">
                                        <table class="table table-hover mb-0" id="parentTable">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>ID</th>
                                                    <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                                                    <th style="width: 80px;">–î–µ–π—Å—Ç–≤–∏–µ</th>
                                                </tr>
                                            </thead>
                                            <tbody id="parentContainer">
                                                <tr>
                                                    <td colspan="3" class="text-center text-muted">
                                                        –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —Å–≤—è–∑–∏
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                <div class="card-footer">
                                    <small class="text-muted" id="parentCount">–ó–∞–ø–∏—Å–µ–π: 0</small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-7">
                            <div class="card h-100">
                                <div class="card-header bg-success text-white">
                                    <i class="bi bi-box-arrow-in-right"></i> 
                                    <span id="childTitle">–°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</span>
                                </div>
                                <div class="card-body p-0">
                                    <div class="table-wrap" style="height: 450px;">
                                        <table class="table table-hover mb-0" id="childTable">
                                            <thead class="table-light">
                                                <tr id="childHeaders">
                                                    <th>ID</th>
                                                    <th>–î–∞–Ω–Ω—ã–µ</th>
                                                </tr>
                                            </thead>
                                            <tbody id="childContainer">
                                                <tr>
                                                    <td colspan="2" class="text-center text-muted">
                                                        –í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–ø–∏—Å—å –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                <div class="card-footer">
                                    <small class="text-muted" id="childCount">–°–≤—è–∑–∞–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π: 0</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
}
async function loadRelation(relationKey) {
    if (!relationKey) {
        document.getElementById("parentContainer").innerHTML = `
            <tr>
                <td colspan="3" class="text-center text-muted">
                    –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —Å–≤—è–∑–∏
                </td>
            </tr>
        `;
        document.getElementById("childContainer").innerHTML = `
            <tr>
                <td colspan="2" class="text-center text-muted">
                    –í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–ø–∏—Å—å –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã
                </td>
            </tr>
        `;
        return;
    }

    const [baseTable, childTable] = relationKey.split(':');
    const relation = ONE_TO_MANY_RELATIONS.find(r => 
        r.base === baseTable && r.childTable === childTable
    );
    
    if (!relation) return;

    try {
        // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏
        document.getElementById("parentTitle").textContent = relation.baseDisplayName;
        document.getElementById("childTitle").textContent = relation.childDisplayName;
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ
        const parentResp = await axios.get(`${CORE_BASE_URL}/tables/${relation.base}`);
        const parentData = parentResp.data;
        
        const parentContainer = document.getElementById("parentContainer");
        
        if (!parentData || parentData.length === 0) {
            parentContainer.innerHTML = `
                <tr>
                    <td colspan="3" class="text-center text-muted">
                        –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –≤ —Ç–∞–±–ª–∏—Ü–µ ${relation.baseDisplayName}
                    </td>
                </tr>
            `;
            document.getElementById("parentCount").textContent = "–ó–∞–ø–∏—Å–µ–π: 0";
            return;
        }
        
        parentContainer.innerHTML = parentData.map(item => `
            <tr class="parent-row" data-id="${item[relation.baseIdField]}" 
                onclick="selectParentRow(this, ${item[relation.baseIdField]}, '${relation.childTable}', '${relation.childFk}')"
                style="cursor: pointer;">
                <td>${item[relation.baseIdField]}</td>
                <td>${formatValue(item[relation.baseNameField])}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary"
                            onclick="event.stopPropagation(); loadChildData('${relation.childTable}', '${relation.childFk}', ${item[relation.baseIdField]})">
                        –ü–æ–∫–∞–∑–∞—Ç—å
                    </button>
                </td>
            </tr>
        `).join('');
        
        document.getElementById("parentCount").textContent = `–ó–∞–ø–∏—Å–µ–π: ${parentData.length}`;
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤—É—é –∑–∞–ø–∏—Å—å
        if (parentData.length > 0) {
            const firstRow = parentContainer.querySelector('.parent-row');
            const firstId = parentData[0][relation.baseIdField];
            selectParentRow(firstRow, firstId, relation.childTable, relation.childFk);
            await loadChildData(relation.childTable, relation.childFk, firstId);
        }
        
    } catch (error) {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–≤—è–∑–∏:", error);
        document.getElementById("parentContainer").innerHTML = `
            <tr>
                <td colspan="3" class="text-center text-danger">
                    –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}
                </td>
            </tr>
        `;
        document.getElementById("parentCount").textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏";
    }
}

function selectParentRow(rowElement, parentId, childTable, fkColumn) {
    // –°–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–æ –≤—Å–µ—Ö —Å—Ç—Ä–æ–∫
    document.querySelectorAll('.parent-row').forEach(row => {
        row.classList.remove('table-primary');
    });
    
    // –í—ã–¥–µ–ª—è–µ–º —Ç–µ–∫—É—â—É—é —Å—Ç—Ä–æ–∫—É
    rowElement.classList.add('table-primary');
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–æ—á–µ—Ä–Ω–∏–µ –¥–∞–Ω–Ω—ã–µ
    loadChildData(childTable, fkColumn, parentId);
}

async function loadChildData(childTable, fkColumn, parentId) {
    const childContainer = document.getElementById("childContainer");
    const childHeaders = document.getElementById("childHeaders");
    
    childContainer.innerHTML = `
        <tr>
            <td colspan="2" class="text-center">
                <div class="spinner-border spinner-border-sm"></div>
                –ó–∞–≥—Ä—É–∑–∫–∞ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö...
            </td>
        </tr>
    `;
    
    try {
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–æ—á–µ—Ä–Ω–∏–µ –¥–∞–Ω–Ω—ã–µ
        const resp = await axios.get(`${CORE_BASE_URL}/tables/${childTable}/filter`, {
            params: { 
                column: fkColumn, 
                value: parentId 
            }
        });
        
        const childData = resp.data;
        
        if (!childData || childData.length === 0) {
            childContainer.innerHTML = `
                <tr>
                    <td colspan="2" class="text-center text-muted">
                        –ù–µ—Ç —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π
                    </td>
                </tr>
            `;
            document.getElementById("childCount").textContent = "–°–≤—è–∑–∞–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π: 0";
            return;
        }
        
        // –ü–æ–ª—É—á–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∏–∑ –ø–µ—Ä–≤–æ–π –∑–∞–ø–∏—Å–∏
        const headers = Object.keys(childData[0]);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ —Ç–∞–±–ª–∏—Ü—ã
        childHeaders.innerHTML = headers.map(h => 
            `<th>${getColumnDisplayName(h)}</th>`
        ).join('');
        
        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
        childContainer.innerHTML = childData.map(row => `
            <tr>
                ${headers.map(h => `
                    <td>${formatChildValue(row[h], h)}</td>
                `).join('')}
            </tr>
        `).join('');
        
        document.getElementById("childCount").textContent = `–°–≤—è–∑–∞–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π: ${childData.length}`;
        
    } catch (error) {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ—á–µ—Ä–Ω–∏—Ö –¥–∞–Ω–Ω—ã—Ö:", error);
        childContainer.innerHTML = `
            <tr>
                <td colspan="2" class="text-center text-danger">
                    –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}
                </td>
            </tr>
        `;
        document.getElementById("childCount").textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏";
    }
}

function formatChildValue(value, columnName) {
    if (value === null || value === undefined) return '<span class="text-muted">‚Äî</span>';
    
    // –û—Å–æ–±—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö –∫–æ–ª–æ–Ω–æ–∫
    if (columnName === 'is_confirmed' || columnName === 'equipment_damaged' || columnName === 'is_active') {
        return value ? 
            '<span class="badge bg-success">–î–∞</span>' : 
            '<span class="badge bg-danger">–ù–µ—Ç</span>';
    }
    
    if (columnName.includes('date')) {
        try {
            return new Date(value).toLocaleDateString('ru-RU');
        } catch {
            return value;
        }
    }
    
    if (columnName.includes('price') || columnName.includes('amount')) {
        return parseFloat(value).toLocaleString('ru-RU', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        }) + ' ‚ÇΩ';
    }
    
    if (columnName.includes('tons') || columnName.includes('volume')) {
        return parseFloat(value).toLocaleString('ru-RU', {
            minimumFractionDigits: 1,
            maximumFractionDigits: 1
        }) + ' —Ç';
    }
    
    return formatValue(value);
}

    // ==================== –†–ï–ê–õ–¨–ù–´–ï –û–¢–ß–ï–¢–´ ====================
    function showReportsView() {
        const content = document.getElementById("contentArea");
        const defaultReport = REAL_REPORTS[0];
        
        content.innerHTML = `
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="section-title">–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–æ–≤</h5>
                        <p class="text-muted mb-4">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –æ—Ç—á–µ—Ç–∞ –∏ —É–∫–∞–∂–∏—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è</p>
                        
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label class="form-label">–¢–∏–ø –æ—Ç—á–µ—Ç–∞:</label>
                                <select id="reportType" class="form-select" onchange="updateReportFilters()">
                                    ${REAL_REPORTS.map(report => 
                                        `<option value="${report.id}">${report.name}</option>`
                                    ).join('')}
                                </select>
                            </div>
                        </div>
                        
                        <div class="report-params" id="reportFilters">
                            <!-- –§–∏–ª—å—Ç—Ä—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                        </div>
                        
                        <div class="row mb-4">
                            <div class="col-12">
                                <button class="btn btn-primary w-100" onclick="generateRealReport()">
                                    –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á–µ—Ç
                                </button>
                            </div>
                        </div>
                        
                        <div class="table-wrap bg-white" id="reportResultContainer">
                            <div class="p-3 text-center text-muted">
                                –í—ã–±–µ—Ä–∏—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏ –Ω–∞–∂–º–∏—Ç–µ "–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á–µ—Ç"
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;

        updateReportFilters();
    }

    function updateReportFilters() {
        const reportType = document.getElementById("reportType").value;
        const report = REAL_REPORTS.find(r => r.id === reportType);
        const filtersContainer = document.getElementById("reportFilters");
        
        if (!report || !report.params) {
            filtersContainer.innerHTML = '<p class="text-muted">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –Ω–µ —Ç—Ä–µ–±—É—é—Ç—Å—è</p>';
            return;
        }
        
        let filtersHTML = '<div class="row g-3">';
        
        report.params.forEach((param, index) => {
            filtersHTML += `
                <div class="col-md-${report.params.length > 2 ? '4' : '6'}">
                    <label class="form-label">${param.label}${param.optional ? ' (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)' : ''}</label>
            `;
            
            if (param.type === 'select') {
                filtersHTML += `
                    <select id="${param.name}" class="form-select">
                        ${param.options.map(opt => 
                            `<option value="${opt.value}">${opt.label}</option>`
                        ).join('')}
                    </select>
                `;
            } else if (param.type === 'date') {
                const today = new Date().toISOString().split('T')[0];
                const defaultDate = param.name === 'from' ? 
                    new Date(new Date().setMonth(new Date().getMonth() - 1)).toISOString().split('T')[0] : 
                    today;
                filtersHTML += `
                    <input type="date" id="${param.name}" class="form-control" value="${defaultDate}">
                `;
            } else if (param.type === 'number') {
                const currentYear = new Date().getFullYear();
                const defaultValue = param.name === 'year' ? currentYear : 
                                   param.name === 'month' ? new Date().getMonth() + 1 : '';
                filtersHTML += `
                    <input type="number" id="${param.name}" class="form-control" 
                           placeholder="${param.placeholder || ''}" value="${defaultValue}">
                `;
            } else {
                filtersHTML += `
                    <input type="text" id="${param.name}" class="form-control" 
                           placeholder="${param.placeholder || ''}">
                `;
            }
            
            filtersHTML += `</div>`;
        });
        
        filtersHTML += '</div>';
        filtersContainer.innerHTML = filtersHTML;
    }

    async function generateRealReport() {
        const reportType = document.getElementById("reportType").value;
        const container = document.getElementById("reportResultContainer");
        const report = REAL_REPORTS.find(r => r.id === reportType);
        
        container.innerHTML = "<div class='text-center p-5'><div class='spinner-border'></div><p class='mt-2'>–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–∞...</p></div>";
        
        try {
            // –°–æ–±–∏—Ä–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
            const params = {};
            if (report.params) {
                report.params.forEach(param => {
                    const element = document.getElementById(param.name);
                    if (element) {
                        const value = element.value.trim();
                        if (value !== '' || param.optional) {
                            if (param.type === 'number') {
                                params[param.name] = parseInt(value);
                            } else if (param.type === 'boolean') {
                                params[param.name] = value === 'true';
                            } else {
                                params[param.name] = value;
                            }
                        }
                    }
                });
            }
            
            console.log("–ó–∞–ø—Ä–æ—Å –æ—Ç—á–µ—Ç–∞:", reportType, "—Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏:", params);
            
            // –î–µ–ª–∞–µ–º –∑–∞–ø—Ä–æ—Å –∫ –±—ç–∫–µ–Ω–¥—É
            const response = await axios.get(`${CORE_BASE_URL}/reports/${reportType}`, {
                params: params
            });
            
            const data = response.data;
            
            if (!data || data.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-info">
                        <h6>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</h6>
                        <p>–ü–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–º –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º –¥–∞–Ω–Ω—ã—Ö –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</p>
                    </div>
                `;
                return;
            }
            
            // –§–æ—Ä–º–∏—Ä—É–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
            let title = report.name;
            if (Object.keys(params).length > 0) {
                const paramText = Object.entries(params)
                    .map(([key, value]) => {
                        const paramLabel = report.params?.find(p => p.name === key)?.label || key;
                        return `${paramLabel}: ${value}`;
                    })
                    .join(', ');
                title += ` (${paramText})`;
            }
            
            container.innerHTML = `
                <div class="p-3">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0">${title}</h6>
                        <button class="btn btn-sm btn-outline-secondary" onclick="exportToExcel()">
                            –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel
                        </button>
                    </div>
                    ${renderRealReportTable(data)}
                    <div class="mt-3 text-end text-muted">
                        <small>–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π: ${data.length}</small>
                    </div>
                </div>
            `;
            
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç—á–µ—Ç–∞:", error);
            container.innerHTML = `
                <div class="alert alert-danger">
                    <h5>–û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç—á–µ—Ç–∞</h5>
                    <p>${error.response?.data?.message || error.response?.data || error.message}</p>
                    <p class="mt-2"><small>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –≤–≤–µ–¥–µ–Ω–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–µ—Ä–∞.</small></p>
                    <button class="btn btn-sm btn-secondary mt-2" onclick="generateRealReport()">
                        –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
                    </button>
                </div>
            `;
        }
    }

    function renderRealReportTable(data) {
        if (!data || data.length === 0) {
            return '<div class="alert alert-info">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</div>';
        }
        
        const headers = Object.keys(data[0]);
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫–∞–∫–∏–µ —Å—Ç–æ–ª–±—Ü—ã —Å–æ–¥–µ—Ä–∂–∞—Ç —á–∏—Å–ª–∞ –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        const numericColumns = headers.filter(header => {
            return data.some(row => {
                const val = row[header];
                return typeof val === 'number' || 
                       (typeof val === 'string' && !isNaN(parseFloat(val)) && isFinite(val));
            });
        });
        
        let html = `
            <table class="table table-bordered table-hover">
                <thead class="table-light">
                    <tr>
                        ${headers.map(h => `<th>${formatReportColumnName(h)}</th>`).join('')}
                    </tr>
                </thead>
                <tbody>
        `;
        
        data.forEach((row, rowIndex) => {
            html += `<tr>`;
            headers.forEach(header => {
                let value = row[header];
                let displayValue = '';
                
                if (value === null || value === undefined) {
                    displayValue = '-';
                } else if (numericColumns.includes(header)) {
                    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —á–∏—Å–ª–∞
                    const num = parseFloat(value);
                    if (!isNaN(num)) {
                        if (header.includes('price') || header.includes('revenue') || header.includes('amount')) {
                            // –î–µ–Ω–µ–∂–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
                            displayValue = num.toLocaleString('ru-RU', {
                                minimumFractionDigits: 2,
                                maximumFractionDigits: 2
                            }) + ' ‚ÇΩ';
                        } else if (header.includes('tons') || header.includes('volume') || header.includes('production')) {
                            // –¢–æ–Ω–Ω—ã
                            displayValue = num.toLocaleString('ru-RU', {
                                minimumFractionDigits: 1,
                                maximumFractionDigits: 1
                            }) + ' —Ç';
                        } else if (num === Math.floor(num)) {
                            // –¶–µ–ª—ã–µ —á–∏—Å–ª–∞
                            displayValue = num.toLocaleString('ru-RU');
                        } else {
                            // –î—Ä–æ–±–Ω—ã–µ —á–∏—Å–ª–∞
                            displayValue = num.toLocaleString('ru-RU', {
                                minimumFractionDigits: 2,
                                maximumFractionDigits: 2
                            });
                        }
                    } else {
                        displayValue = value;
                    }
                } else if (typeof value === 'boolean') {
                    displayValue = value ? '–î–∞' : '–ù–µ—Ç';
                } else if (typeof value === 'string' && value.match(/^\d{4}-\d{2}-\d{2}/)) {
                    // –î–∞—Ç–∞
                    displayValue = new Date(value).toLocaleDateString('ru-RU');
                } else {
                    displayValue = value;
                }
                
                html += `<td>${displayValue}</td>`;
            });
            html += `</tr>`;
        });
        
        html += `</tbody></table>`;
        return html;
    }

    function formatReportColumnName(column) {
        const names = {
            'deposit_name': '–ú–µ—Å—Ç–æ—Ä–æ–∂–¥–µ–Ω–∏–µ',
            'mineral_name': '–ú–∏–Ω–µ—Ä–∞–ª',
            'shifts_count': '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–º–µ–Ω',
            'total_production': '–í—Å–µ–≥–æ –¥–æ–±—ã—Ç–æ',
            'avg_production_per_shift': '–°—Ä–µ–¥–Ω—è—è –¥–æ–±—ã—á–∞ –∑–∞ —Å–º–µ–Ω—É',
            'month': '–ú–µ—Å—è—Ü',
            'sales_count': '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–¥–∞–∂',
            'total_sold_tons': '–í—Å–µ–≥–æ –ø—Ä–æ–¥–∞–Ω–æ —Ç–æ–Ω–Ω',
            'avg_price': '–°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞',
            'total_revenue': '–û–±—â–∞—è –≤—ã—Ä—É—á–∫–∞',
            'first_sale_date': '–ü–µ—Ä–≤–∞—è –ø—Ä–æ–¥–∞–∂–∞',
            'last_sale_date': '–ü–æ—Å–ª–µ–¥–Ω—è—è –ø—Ä–æ–¥–∞–∂–∞',
            'absolute_volume': '–û–±—ä–µ–º –∑–∞–ø–∞—Å–æ–≤',
            'is_confirmed': '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ',
            'survey_year': '–ì–æ–¥ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è',
            'status': '–°—Ç–∞—Ç—É—Å',
            'has_railroad': '–ñ/–¥ —Å–æ–æ–±—â–µ–Ω–∏–µ',
            'has_power_supply': '–≠–ª–µ–∫—Ç—Ä–æ—Å–Ω–∞–±–∂–µ–Ω–∏–µ',
            'nearby_settlement': '–ë–ª–∏–∂–∞–π—à–∏–π –Ω–∞—Å–µ–ª–µ–Ω–Ω—ã–π –ø—É–Ω–∫—Ç',
            'team_name': '–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã',
            'foreman_name': '–ë—Ä–∏–≥–∞–¥–∏—Ä',
            'working_days': '–†–∞–±–æ—á–∏—Ö –¥–Ω–µ–π',
            'avg_daily_production': '–°—Ä–µ–¥–Ω—è—è –¥–Ω–µ–≤–Ω–∞—è –¥–æ–±—ã—á–∞',
            'avg_shift_production': '–°—Ä–µ–¥–Ω—è—è –¥–æ–±—ã—á–∞ –∑–∞ —Å–º–µ–Ω—É',
            'incidents_count': '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–Ω—Ü–∏–¥–µ–Ω—Ç–æ–≤',
            'company_name': '–ö–æ–º–ø–∞–Ω–∏—è',
            'contact_name': '–ö–æ–Ω—Ç–∞–∫—Ç–Ω–æ–µ –ª–∏—Ü–æ',
            'contact_phone': '–ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω',
            'purchase_count': '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–∫—É–ø–æ–∫',
            'total_purchased_tons': '–í—Å–µ–≥–æ –∫—É–ø–ª–µ–Ω–æ —Ç–æ–Ω–Ω',
            'total_spent': '–í—Å–µ–≥–æ –ø–æ—Ç—Ä–∞—á–µ–Ω–æ',
            'avg_price_paid': '–°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞ –ø–æ–∫—É–ø–∫–∏',
            'first_purchase_date': '–ü–µ—Ä–≤–∞—è –ø–æ–∫—É–ø–∫–∞',
            'last_purchase_date': '–ü–æ—Å–ª–µ–¥–Ω—è—è –ø–æ–∫—É–ø–∫–∞',
            'year': '–ì–æ–¥',
            'month_number': '–ú–µ—Å—è—Ü'
        };
        
        return names[column] || column.replace(/_/g, ' ');
    }

    function exportToExcel() {
        const table = document.querySelector('#reportResultContainer table');
        if (!table) {
            alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞');
            return;
        }
        
        let csv = [];
        const rows = table.querySelectorAll('tr');
        
        for (let i = 0; i < rows.length; i++) {
            const row = [], cols = rows[i].querySelectorAll('td, th');
            
            for (let j = 0; j < cols.length; j++) {
                // –£–±–∏—Ä–∞–µ–º —Å–∏–º–≤–æ–ª—ã –≤–∞–ª—é—Ç—ã –∏ –µ–¥–∏–Ω–∏—Ü—ã –∏–∑–º–µ—Ä–µ–Ω–∏—è –¥–ª—è —á–∏—Å—Ç—ã—Ö —á–∏—Å–µ–ª
                let data = cols[j].textContent.trim();
                data = data.replace(/[‚ÇΩ—Ç]/g, '').trim();
                row.push(data);
            }
            
            csv.push(row.join(';'));
        }
        
        const csvContent = "data:text/csv;charset=utf-8,\uFEFF" + csv.join('\n');
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `–æ—Ç—á–µ—Ç_${new Date().toISOString().slice(0,10)}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // ==================== –í–í–û–î –î–ê–ù–ù–´–• –ß–ï–†–ï–ó –ü–†–ï–î–°–¢–ê–í–õ–ï–ù–ò–Ø ====================
    function showDataInputView() {
        const content = document.getElementById("contentArea");
        const editableView = EDITABLE_VIEWS[0];
        
        content.innerHTML = `
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="section-title">–í–≤–æ–¥ –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è</h5>
                        <p class="text-muted mb-4">–†–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ –ª—é–±—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ —Ç–∞–±–ª–∏—Ü–∞—Ö</p>
                        
                        <div class="row mb-4">
                            <div class="col-md-8">
                                <h6 class="mb-2">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:</h6>
                                <select id="editableViewSelect" class="form-select" onchange="loadEditableView(this.value)">
                                    ${EDITABLE_VIEWS.map(view => 
                                        `<option value="${view}">${getViewDisplayName(view)}</option>`
                                    ).join('')}
                                </select>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <button class="btn btn-primary w-100 mb-2" onclick="addRowToEditableView()">
                                    –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å
                                </button>
                            </div>
                            <div class="col-md-4">
                                <button class="btn btn-success w-100 mb-2" onclick="saveEditableViewChanges()">
                                    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å—ë
                                </button>
                            </div>
                            <div class="col-md-4">
                                <button class="btn btn-danger w-100 mb-2" onclick="deleteSelectedFromView()">
                                    –£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω–æ–µ
                                </button>
                            </div>
                        </div>
                        
                        <div class="alert alert-info">
                            <small>‚ÑπÔ∏è –ö–ª–∏–∫–Ω–∏—Ç–µ –ø–æ –ª—é–±–æ–π —è—á–µ–π–∫–µ —á—Ç–æ–±—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å. –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –±—É–¥—É—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å—ë"</small>
                        </div>
                        
                        <div class="table-wrap bg-white">
                            <div id="editableViewContainer" class="p-3"></div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        loadEditableView(editableView);
    }

    async function loadEditableView(viewName) {
        const container = document.getElementById("editableViewContainer");
        currentTableName = viewName;
        
        modifiedRows.clear();
        newRows.clear();
        
        container.innerHTML = "<div class='text-center p-5'><div class='spinner-border'></div><p class='mt-2'>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p></div>";
        
        try {
            const resp = await axios.get(`${CORE_BASE_URL}/views/${viewName}`);
            renderEditableView(container, resp.data);
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:", error);
            container.innerHTML = `
                <div class="alert alert-danger">
                    <h5>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è</h5>
                    <p>${error.response?.data || error.message}</p>
                </div>
            `;
        }
    }

    function renderEditableView(container, data) {
        currentTableData = data || [];
        modifiedRows.clear();
        newRows.clear();
        
        if (!data || data.length === 0) {
            container.innerHTML = `
                <div class="alert alert-info">
                    <h6>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</h6>
                    <p>–ù–∞–∂–º–∏—Ç–µ "–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å", —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—É—é –∑–∞–ø–∏—Å—å.</p>
                </div>
            `;
            return;
        }

        const headers = Object.keys(data[0]);
        
        let html = `
            <table class="table table-hover table-striped data-table">
                <thead>
                    <tr>
                        <th style="width: 50px;">#</th>
                        ${headers.map(h => `<th>${getColumnDisplayName(h)}</th>`).join('')}
                    </tr>
                </thead>
                <tbody>
        `;

        data.forEach((row, index) => {
            const rowId = row.id || `row_${index}`;
            html += `<tr data-id="${rowId}">`;
            
            html += `<td><input type="checkbox" class="row-selector form-check-input" data-id="${rowId}"></td>`;
            
            headers.forEach(col => {
                const value = row[col];
                const displayValue = formatValue(value);
                
                html += `<td class="editable" contenteditable="true" data-col="${col}" 
                          oninput="markRowAsModified('${rowId}')">${displayValue}</td>`;
            });
            
            html += `</tr>`;
        });

        html += `</tbody></table>`;
        container.innerHTML = html;
    }

    function addRowToEditableView() {
        if (!currentTableName) {
            alert("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ");
            return;
        }
        
        const container = document.getElementById("editableViewContainer");
        let table = container.querySelector('table');
        
        if (!table) {
            const structure = {
                "view_production_daily": ["id", "shift_id", "shift_date", "start_time", "end_time", "foreman_name", "tons_of_ore", "equipment_damaged", "notes"],
                "view_sales_report": ["id", "buyer_id", "buyer_name", "ore_deposit_id", "deposit_name", "mineral_id", "mineral_name", "sale_date", "sold_tons", "sale_price_per_ton", "total_amount"]
            };
            
            const headers = structure[currentTableName] || [];
            
            let html = `
                <table class="table table-hover table-striped data-table">
                    <thead>
                        <tr>
                            <th style="width: 50px;">#</th>
                            ${headers.map(h => `<th>${getColumnDisplayName(h)}</th>`).join('')}
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            `;
            
            container.innerHTML = html;
            table = container.querySelector('table');
        }
        
        const tbody = table.querySelector('tbody');
        if (!tbody) return;
        
        const headers = Array.from(table.querySelectorAll('thead th'))
            .map(th => th.textContent.trim())
            .filter((h, i) => i > 0);
        
        const newRowId = 'new_' + Date.now();
        const newRow = document.createElement('tr');
        newRow.setAttribute('data-id', newRowId);
        newRow.className = 'new-row';
        
        const checkboxCell = document.createElement('td');
        checkboxCell.innerHTML = `<input type="checkbox" class="row-selector form-check-input" data-id="${newRowId}">`;
        newRow.appendChild(checkboxCell);
        
        headers.forEach((header) => {
            const cell = document.createElement('td');
            const colName = getColumnNameFromDisplay(header);
            
            cell.setAttribute('contenteditable', 'true');
            cell.setAttribute('data-col', colName);
            cell.className = 'editable';
            cell.textContent = '';
            
            cell.addEventListener('input', () => markRowAsModified(newRowId));
            
            newRow.appendChild(cell);
        });
        
        tbody.appendChild(newRow);
        newRows.add(newRowId);
    }

    async function saveEditableViewChanges() {
    if (!currentTableName) {
        alert("–ü—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ");
        return;
    }

    const container = document.getElementById("editableViewContainer");
    if (!container) {
        alert("–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω");
        return;
    }

    try {
        const table = container.querySelector('table');
        if (!table) {
            alert("–¢–∞–±–ª–∏—Ü–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");
            return;
        }

        const rows = table.querySelectorAll('tbody tr');
        const updates = [];
        const creates = [];
        const deletes = [];

        // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ
        rows.forEach((row) => {
            const rowId = row.getAttribute('data-id');
            const isNew = rowId && rowId.startsWith('new_');
            const rowData = {};
            
            // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã—Ö —è—á–µ–µ–∫
            row.querySelectorAll('td[contenteditable="true"]').forEach(cell => {
                const col = cell.getAttribute('data-col');
                let value = cell.textContent.trim();
                
                // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ –≤ null
                if (value === '') {
                    value = null;
                } 
                // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º "–î–∞"/"–ù–µ—Ç" –≤ boolean
                else if (value === '–î–∞') {
                    value = true;
                } else if (value === '–ù–µ—Ç') {
                    value = false;
                }
                // –ü—Ä–æ–±—É–µ–º –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —á–∏—Å–ª–∞
                else if (!isNaN(value) && value !== '') {
                    if (value.includes('.')) {
                        value = parseFloat(value);
                    } else {
                        value = parseInt(value);
                    }
                }
                
                rowData[col] = value;
            });

            if (isNew && Object.keys(rowData).length > 0) {
                creates.push(rowData);
            } else if (!isNew && modifiedRows.has(rowId) && Object.keys(rowData).length > 0) {
                // –ò—â–µ–º ID –≤ —Ç–∞–±–ª–∏—Ü–µ –¥–∞–Ω–Ω—ã—Ö
                const existingRow = currentTableData.find(r => 
                    r.id == rowId || r.id.toString() === rowId
                );
                if (existingRow && existingRow.id) {
                    rowData.id = existingRow.id;
                    updates.push(rowData);
                }
            }
        });

        // –°–æ–±–∏—Ä–∞–µ–º ID –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è
        const checkboxes = container.querySelectorAll('.row-selector:checked');
        checkboxes.forEach(checkbox => {
            const rowId = checkbox.getAttribute('data-id');
            if (!rowId.startsWith('new_') && rowId) {
                // –ò—â–µ–º ID –≤ —Ç–∞–±–ª–∏—Ü–µ –¥–∞–Ω–Ω—ã—Ö
                const existingRow = currentTableData.find(r => 
                    r.id == rowId || r.id.toString() === rowId
                );
                if (existingRow && existingRow.id) {
                    deletes.push(existingRow.id);
                }
            }
        });

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –±–∞–∑–æ–≤—É—é —Ç–∞–±–ª–∏—Ü—É
        const baseTable = VIEW_TO_TABLE_MAP[currentTableName];
        if (!baseTable) {
            throw new Error("–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –±–∞–∑–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞ –¥–ª—è —ç—Ç–æ–≥–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è");
        }

        const results = {
            created: 0,
            updated: 0,
            deleted: 0
        };

        // –£–¥–∞–ª–µ–Ω–∏–µ
        for (const id of deletes) {
            try {
                const response = await axios.delete(`${CORE_BASE_URL}/tables/${baseTable}/${id}`);
                if (response.data.success) {
                    results.deleted++;
                } else {
                    throw new Error(`–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ ID ${id}`);
                }
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:", error);
                throw new Error(`–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å —Å ID ${id}: ${error.response?.data || error.message}`);
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ
        for (const data of updates) {
            try {
                const response = await axios.put(`${CORE_BASE_URL}/tables/${baseTable}/${data.id}`, data);
                if (response.data.success) {
                    results.updated++;
                } else {
                    throw new Error(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ ID ${data.id}`);
                }
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:", error);
                throw new Error(`–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –∑–∞–ø–∏—Å—å —Å ID ${data.id}: ${error.response?.data || error.message}`);
            }
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ
        for (const data of creates) {
            try {
                const response = await axios.post(`${CORE_BASE_URL}/tables/${baseTable}`, data);
                if (response.data.success) {
                    results.created++;
                } else {
                    throw new Error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–ø–∏—Å–∏");
                }
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è:", error);
                throw new Error(`–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å—å: ${error.response?.data || error.message}`);
            }
        }

        modifiedRows.clear();
        newRows.clear();

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        let message = "‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!\n";
        if (results.created > 0) message += `‚Ä¢ –°–æ–∑–¥–∞–Ω–æ –∑–∞–ø–∏—Å–µ–π: ${results.created}\n`;
        if (results.updated > 0) message += `‚Ä¢ –û–±–Ω–æ–≤–ª–µ–Ω–æ –∑–∞–ø–∏—Å–µ–π: ${results.updated}\n`;
        if (results.deleted > 0) message += `‚Ä¢ –£–¥–∞–ª–µ–Ω–æ –∑–∞–ø–∏—Å–µ–π: ${results.deleted}\n`;
        
        if (results.created === 0 && results.updated === 0 && results.deleted === 0) {
            message = "‚ÑπÔ∏è –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è";
        }
        
        alert(message);
        
        // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ
        await loadEditableView(currentTableName);
        
    } catch (error) {
        console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:", error);
        alert("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏:\n" + error.message);
    }
}    function deleteSelectedFromView() {
        const container = document.getElementById("editableViewContainer");
        const checkboxes = container.querySelectorAll('.row-selector:checked');
        
        if (checkboxes.length === 0) {
            alert("–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–ø–∏—Å–∏ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è");
            return;
        }
        
        if (confirm(`–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏ (${checkboxes.length})?`)) {
            checkboxes.forEach(checkbox => {
                const rowId = checkbox.getAttribute('data-id');
                const row = checkbox.closest('tr');
                if (row) {
                    row.remove();
                }
            });
        }
    }

    // ==================== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ====================
    function getTableDisplayName(tableName) {
        const names = {
            'ore_deposits': '–ú–µ—Å—Ç–æ—Ä–æ–∂–¥–µ–Ω–∏—è',
            'minerals': '–ú–∏–Ω–µ—Ä–∞–ª—ã',
            'buyers_companies': '–ö–æ–º–ø–∞–Ω–∏–∏-–ø–æ–∫—É–ø–∞—Ç–µ–ª–∏',
            'deposit_owner': '–í–ª–∞–¥–µ–ª—å—Ü—ã –º–µ—Å—Ç–æ—Ä–æ–∂–¥–µ–Ω–∏–π',
            'reserves': '–ó–∞–ø–∞—Å—ã',
            'sales_to_companies': '–ü—Ä–æ–¥–∞–∂–∏',
            'work_shifts': '–†–∞–±–æ—á–∏–µ —Å–º–µ–Ω—ã',
            'mining_teams': '–ì–æ—Ä–Ω–æ–¥–æ–±—ã–≤–∞—é—â–∏–µ –∫–æ–º–∞–Ω–¥—ã',
            'shift_production': '–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ –∑–∞ —Å–º–µ–Ω—É',
            'miners': '–®–∞—Ö—Ç–µ—Ä—ã',
            'teams': '–ö–æ–º–∞–Ω–¥—ã',
            'team_names': '–ù–∞–∑–≤–∞–Ω–∏—è –∫–æ–º–∞–Ω–¥'
        };
        return names[tableName] || tableName;
    }

    function getViewDisplayName(viewName) {
        const names = {
            'view_deposits_summary': '–°–≤–æ–¥–∫–∞ –ø–æ –º–µ—Å—Ç–æ—Ä–æ–∂–¥–µ–Ω–∏—è–º',
            'view_reserves_details': '–î–µ—Ç–∞–ª–∏ –∑–∞–ø–∞—Å–æ–≤',
            'view_sales_report': '–û—Ç—á–µ—Ç –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º',
            'view_production_daily': '–î–Ω–µ–≤–Ω–∞—è –¥–æ–±—ã—á–∞',
            'view_team_performance': '–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫–æ–º–∞–Ω–¥',
            'view_mineral_prices': '–¶–µ–Ω—ã –Ω–∞ –º–∏–Ω–µ—Ä–∞–ª—ã'
        };
        return names[viewName] || viewName;
    }

    function getColumnDisplayName(column) {
        const names = {
            'id': 'ID',
            'name': '–ù–∞–∑–≤–∞–Ω–∏–µ',
            'status': '–°—Ç–∞—Ç—É—Å',
            'discovery_year': '–ì–æ–¥ –æ—Ç–∫—Ä—ã—Ç–∏—è',
            'latitude': '–®–∏—Ä–æ—Ç–∞',
            'longtitude': '–î–æ–ª–≥–æ—Ç–∞',
            'has_railroad': '–ñ/–¥ —Å–æ–æ–±—â–µ–Ω–∏–µ',
            'has_power_supply': '–≠–ª–µ–∫—Ç—Ä–æ—Å–Ω–∞–±–∂–µ–Ω–∏–µ',
            'nearby_settlement': '–ë–ª–∏–∂–∞–π—à–∏–π –Ω–∞—Å–µ–ª–µ–Ω–Ω—ã–π –ø—É–Ω–∫—Ç',
            'absolute_volume': '–û–±—ä–µ–º –∑–∞–ø–∞—Å–æ–≤',
            'is_confirmed': '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ',
            'sale_date': '–î–∞—Ç–∞ –ø—Ä–æ–¥–∞–∂–∏',
            'sold_tons': '–ü—Ä–æ–¥–∞–Ω–æ —Ç–æ–Ω–Ω',
            'sale_price_per_ton': '–¶–µ–Ω–∞ –∑–∞ —Ç–æ–Ω–Ω—É',
            'shift_date': '–î–∞—Ç–∞ —Å–º–µ–Ω—ã',
            'start_time': '–í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞',
            'end_time': '–í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è',
            'foreman_name': '–ò–º—è –±—Ä–∏–≥–∞–¥–∏—Ä–∞',
            'foreman_phone': '–¢–µ–ª–µ—Ñ–æ–Ω –±—Ä–∏–≥–∞–¥–∏—Ä–∞',
            'is_active': '–ê–∫—Ç–∏–≤–µ–Ω',
            'tons_of_ore': '–¢–æ–Ω–Ω —Ä—É–¥—ã',
            'equipment_damaged': '–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–æ',
            'notes': '–ü—Ä–∏–º–µ—á–∞–Ω–∏—è',
            'license_number': '–ù–æ–º–µ—Ä –ª–∏—Ü–µ–Ω–∑–∏–∏',
            'contact_name': '–ö–æ–Ω—Ç–∞–∫—Ç–Ω–æ–µ –ª–∏—Ü–æ',
            'contact_phone': '–ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω',
            'acquisition_year': '–ì–æ–¥ –ø—Ä–∏–æ–±—Ä–µ—Ç–µ–Ω–∏—è',
            'expiration_year': '–ì–æ–¥ –æ–∫–æ–Ω—á–∞–Ω–∏—è',
            'shift_id': 'ID —Å–º–µ–Ω—ã',
            'buyer_id': 'ID –ø–æ–∫—É–ø–∞—Ç–µ–ª—è',
            'owner_id': 'ID –ø—Ä–æ–¥–∞–≤—Ü–∞',
            'longitude': '–î–æ–ª–≥–æ—Ç–∞',
            'buyer_name': '–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏',
            'ore_deposit_id': 'ID –º–µ—Å—Ç–æ—Ä–æ–∂–¥–µ–Ω–∏—è',
            'deposit_name': '–ù–∞–∑–≤–∞–Ω–∏–µ –º–µ—Å—Ç–æ—Ä–æ–∂–¥–µ–Ω–∏—è',
            'mineral_id': 'ID –º–∏–Ω–µ—Ä–∞–ª–∞',
            'mineral_name': '–ù–∞–∑–≤–∞–Ω–∏–µ –º–∏–Ω–µ—Ä–∞–ª–∞',
            'total_amount': '–û–±—â–∞—è —Å—É–º–º–∞'
        };
        return names[column] || column.replace(/_/g, ' ');
    }

    function getColumnNameFromDisplay(displayName) {
        const mapping = {
            'ID': 'id',
            '–ù–∞–∑–≤–∞–Ω–∏–µ': 'name',
            '–°—Ç–∞—Ç—É—Å': 'status',
            '–ì–æ–¥ –æ—Ç–∫—Ä—ã—Ç–∏—è': 'discovery_year',
            '–®–∏—Ä–æ—Ç–∞': 'latitude',
            '–î–æ–ª–≥–æ—Ç–∞': 'longtitude',
            '–ñ/–¥ —Å–æ–æ–±—â–µ–Ω–∏–µ': 'has_railroad',
            '–≠–ª–µ–∫—Ç—Ä–æ—Å–Ω–∞–±–∂–µ–Ω–∏–µ': 'has_power_supply',
            '–ë–ª–∏–∂–∞–π—à–∏–π –Ω–∞—Å–µ–ª–µ–Ω–Ω—ã–π –ø—É–Ω–∫—Ç': 'nearby_settlement',
            '–û–±—ä–µ–º –∑–∞–ø–∞—Å–æ–≤': 'absolute_volume',
            '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ': 'is_confirmed',
            '–î–∞—Ç–∞ –ø—Ä–æ–¥–∞–∂–∏': 'sale_date',
            '–ü—Ä–æ–¥–∞–Ω–æ —Ç–æ–Ω–Ω': 'sold_tons',
            '–¶–µ–Ω–∞ –∑–∞ —Ç–æ–Ω–Ω—É': 'sale_price_per_ton',
            '–î–∞—Ç–∞ —Å–º–µ–Ω—ã': 'shift_date',
            '–í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞': 'start_time',
            '–í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è': 'end_time',
            '–ò–º—è –±—Ä–∏–≥–∞–¥–∏—Ä–∞': 'foreman_name',
            '–¢–µ–ª–µ—Ñ–æ–Ω –±—Ä–∏–≥–∞–¥–∏—Ä–∞': 'foreman_phone',
            '–ê–∫—Ç–∏–≤–µ–Ω': 'is_active',
            '–¢–æ–Ω–Ω —Ä—É–¥—ã': 'tons_of_ore',
            '–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–æ': 'equipment_damaged',
            '–ü—Ä–∏–º–µ—á–∞–Ω–∏—è': 'notes',
            '–ù–æ–º–µ—Ä –ª–∏—Ü–µ–Ω–∑–∏–∏': 'license_number',
            '–ö–æ–Ω—Ç–∞–∫—Ç–Ω–æ–µ –ª–∏—Ü–æ': 'contact_name',
            '–ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω': 'contact_phone',
            '–ì–æ–¥ –ø—Ä–∏–æ–±—Ä–µ—Ç–µ–Ω–∏—è': 'acquisition_year',
            '–ì–æ–¥ –æ–∫–æ–Ω—á–∞–Ω–∏—è': 'expiration_year',
            'ID —Å–º–µ–Ω—ã': 'shift_id',
            'ID –ø–æ–∫—É–ø–∞—Ç–µ–ª—è': 'buyer_id',
            'ID –ø—Ä–æ–¥–∞–≤—Ü–∞': 'owner_id',
            '–î–æ–ª–≥–æ—Ç–∞': 'longitude',
            '–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏': 'buyer_name',
            'ID –º–µ—Å—Ç–æ—Ä–æ–∂–¥–µ–Ω–∏—è': 'ore_deposit_id',
            '–ù–∞–∑–≤–∞–Ω–∏–µ –º–µ—Å—Ç–æ—Ä–æ–∂–¥–µ–Ω–∏—è': 'deposit_name',
            'ID –º–∏–Ω–µ—Ä–∞–ª–∞': 'mineral_id',
            '–ù–∞–∑–≤–∞–Ω–∏–µ –º–∏–Ω–µ—Ä–∞–ª–∞': 'mineral_name',
            '–û–±—â–∞—è —Å—É–º–º–∞': 'total_amount'
        };  
        return mapping[displayName] || displayName.toLowerCase().replace(/ /g, '_');
    }

    function formatValue(value) {
        if (value === null || value === undefined) return '';
        if (typeof value === 'boolean') return value ? '–î–∞' : '–ù–µ—Ç';
        if (typeof value === 'number') {
            return Number(value).toString();
        }
        return value.toString();
    }

    function filterTable() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const table = document.querySelector('.data-table');
        if (!table) return;
        
        const rows = table.querySelectorAll('tbody tr');
        rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            row.style.display = text.includes(searchTerm) ? '' : 'none';
        });
    }

    function logout() {
        window.location.href = "/logout";
    }

    document.addEventListener('DOMContentLoaded', initApp);
</script>
</body>
</html>
